<script lang="ts">
  import { onMount } from 'svelte'
  import { derived, writable } from 'svelte/store'

  import { ChevronUp, Information, Search } from 'carbon-icons-svelte'

  let loaded = false

  const cveOverview = writable<CVEOverview[]>([])
  export let columns = [
    { name: 'Build Date', style: 'w-2/12' },
    { name: 'Package Name', style: 'w-2/12' },
    { name: 'Package Ver', style: 'w-1/12' },
    { name: 'Author', style: 'w-1/12' },
    { name: 'CVE Count', style: 'w-1/12' },
    { name: 'Critical', style: 'w-1/12' },
    { name: 'High', style: 'w-1/12' },
    { name: 'Images with Package', style: 'w-1/12' },
  ]

  // Initialize the stores
  let search = writable<string>('')
  let sortBy = writable<string>('build date')
  let sortAsc = writable<boolean>(true)

  // check for filtering
  let isFiltering = false
  $: {
    isFiltering = !!$search
  }

  function filterReports(reports: CVEOverview[], searchTerm: string): CVEOverview[] {
    // filter events by the search term if one exists
    if (!searchTerm) return reports
    const searchValue = searchTerm.toLowerCase()
    return reports.filter(
      (item) =>
        item.build_date.toLowerCase().includes(searchValue) ||
        item.package_name.toLowerCase().includes(searchValue) ||
        item.package_version.toLowerCase().includes(searchValue),
    )
  }

  function sortReports(reports: CVEOverview[], sortKey: string, isAscending: boolean): CVEOverview[] {
    const sortDirection = isAscending ? 1 : -1 // sort events in ascending order by default
    // sort events based on the sort key
    console.log('reports', reports)
    return reports.sort((a, b) => {
      if (sortKey === 'build date') {
        const aTime = new Date(a.build_date).getTime()
        const bTime = new Date(b.build_date).getTime()
        return (aTime - bTime) * sortDirection
      } else if (sortKey === 'cve count' || sortKey === 'critical' || sortKey === 'high') {
        const aValue = Number(a[sortKey as keyof typeof a]) || 0
        const bValue = Number(b[sortKey as keyof typeof b]) || 0
        return (aValue - bValue) * sortDirection
      } else {
        const aValue = String(a[sortKey as keyof typeof a] || '').toLowerCase()
        const bValue = String(b[sortKey as keyof typeof b] || '').toLowerCase()
        return aValue.localeCompare(bValue) * sortDirection
      }
    })
  }

  export const rows = derived([cveOverview, search, sortBy, sortAsc], () => {
    const filteredOverviews = filterReports($cveOverview, $search)
    return sortReports(filteredOverviews, $sortBy, $sortAsc)
  })

  const widths = ['w-1/6', 'w-1/3', 'w-1/4', 'w-2/5', 'w-1/2', 'w-1/5', 'w-1/3', 'w-1/4']
  const skeletonRows = widths.sort(() => Math.random() - 0.5)

  onMount(async () => {
    const response = await fetch('/api/v1/security/reports')
    const data: CVEReports = await response.json()

    cveOverview.update((reports) => {
      return [...data.cluster_overview, ...reports]
    })
    loaded = true
  })
</script>

<section class="table-section">
  <div class="table-container">
    <div class="table-content">
      <div class="table-header">
        <span class="dark:text-white" data-testid="table-header">{'CVE Reports'}</span>
        <!-- {#if isFiltering}
          <span class="dark:text-gray-500 pl-2" data-testid="table-header-results">
            (showing {$rows.length} of {$cveOverview.length})
          </span>
        {:else} -->
        <span class="dark:text-gray-500 pl-2" data-testid="table-header-results">({$cveOverview.length})</span>
        <!-- {/if} -->
        <div class="relative group">
          <Information class="ml-2 w-4 h-4 text-gray-400" />
          <div class="tooltip tooltip-right min-w-72">
            <div class="whitespace-normal">
              {'These are UDS Operator logs scraped from Pepr running in the cluster'}
            </div>
          </div>
        </div>
      </div>
      <div class="table-filter-section">
        <div class="relative lg:w-96">
          <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
            <Search class="h-5 w-5 text-gray-400" />
          </div>
          <input
            type="text"
            name="input-search"
            autocomplete="off"
            class="focus:ring-primary-500 focus:border-primary-500 dark:focus:ring-primary-500 dark:focus:border-primary-500 block w-full rounded-lg border border-gray-300 bg-gray-50 p-2.5 pl-9 text-gray-900 sm:text-sm dark:border-gray-600 dark:bg-gray-700 dark:text-white dark:placeholder-gray-400"
            placeholder="Search"
            data-testid="datatable-search"
            bind:value={$search}
          />
        </div>
        <div class="flex-grow"></div>
        <div
          class="flex flex-shrink-0 flex-col space-y-3 md:flex-row md:items-center md:space-x-3 md:space-y-0 lg:justify-end"
        ></div>
      </div>
      <div class="table-scroll-container">
        <table>
          <thead>
            <tr>
              {#each columns as col}
                <th class={col.style}>
                  <button
                    on:click={() => {
                      $sortBy = col.name === 'resource' ? '_name' : col.name
                      $sortAsc = !$sortAsc
                    }}
                  >
                    {col.name.replaceAll('_', ' ')}
                    <ChevronUp
                      class="sort
                      {$sortAsc ? 'rotate-180' : ''}
                      {$sortBy === col.name ? 'opacity-100' : 'opacity-0'}"
                    />
                  </button>
                </th>
              {/each}
            </tr>
          </thead>
          {#if loaded}
            <tbody>
              {#if $rows.length === 0}
                <tr>
                  <td colspan="4" class="text-center">No matching entries found</td>
                </tr>
              {:else}
                {#each $rows as item}
                  <tr>
                    <td>
                      <span>{item.build_date}</span>
                    </td>
                    <td>{item.package_name}</td>
                    <td class="flex flex-row items-center">
                      {item.package_version}
                    </td>
                    <td>{item.repository}</td>
                    <td>{item.cve_count}</td>
                    <td>{item.critical}</td>
                    <td>{item.high}</td>
                    <td>{item.images_with_package}</td>
                  </tr>
                {/each}
              {/if}
            </tbody>
          {:else}
            <tbody class="animate-pulse">
              {#each skeletonRows as w}
                <tr class="border-b border-gray-700">
                  <td class={columns[0].style}>
                    <div class="h-6 rounded bg-gray-600 w-20"></div>
                  </td>
                  <td class={columns[1].style}>
                    <div class="h-6 bg-gray-500 rounded {w}"></div>
                  </td>
                  <td class={columns[2].style}>
                    <div class="h-6 bg-gray-600 rounded w-20"></div>
                  </td>
                  <td class={columns[3].style}>
                    <div class="h-6 bg-gray-600 rounded w-8"></div>
                  </td>
                  <td class={columns[4].style}>
                    <div class="h-6 bg-gray-600 rounded w-1/2"></div>
                  </td>
                </tr>
              {/each}
            </tbody>
          {/if}
        </table>
      </div>
    </div>
  </div>
</section>
