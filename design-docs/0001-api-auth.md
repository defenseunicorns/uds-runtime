# API Token Authentication

Author(s): @decleaver  
Date Created: Sept 10, 2024  
Status: REVIEW

### Problem Statement
API authentication is needed to prevent unauthorized access to the API from other processes when running UDS Runtime locally.

### Proposal

### Scope and Requirements

### Implementation Details (Currently)
The API uses a token-based authentication system. The token is generated by the backend server and is used to authenticate the user. API authentication is enabled by default, to disable it you can set the `API_AUTH_DISABLED` environment variable to true.

How does the frontend authenticate?
- Backend generates a token when it is started up and launches UDS Runtime in the browser.
    - i.e.(Runtime API connection: `http://127.0.0.1:8080/auth?token=r1hrQ9CcuZMKpY2egjsPrzmge3-YqfqOHjmlIOvdKrLGOLnHPgFWt3dzsdkHwzDdXQAfRRHiH~rbGEx7Jc7rTxTd4riCuqGH`)
- Frontend hits the /auth-status endpoint to see if API authentication is enabled.
    - This is done so that the frontend can get the value of the `API_AUTH_DISABLED` environment variable at runtime.
- If API auth is enabled, the frontend hits the /api/v1/ endpoint and passes the token as a query parameter in the URL to the backend to authenticate the user.
    - When authenticated, the token is stored in `sessionStorage` and is valid for the duration of the page session.
    - The token is then used when creating the EventSources for the various views.
- Reauthentication is possible by hitting the /auth endpoint with the token as a query parameter.
<br><br>

<p style="text-align:center;">
  <img src="./images/api-auth-flow.png" alt="API auth flow diagram">
</p>

- The frontend manages the authentication state (whether API authentication is enabled and whether the user is authenticated) using Svelte stores. These stores can be subscribed to, allowing the frontend to display the appropriate views based on the current authentication state.

### Alternatives Considered
#### Manage authentication state in the backend
Instead of managing state in the frontend, manage the authentication state in the backend. One way this can be accomplished is by using session cookies.

The generated api token would still be used initially by the frontend to authenticate with the backend, but once the token is validated, the backend would generate a session ID and set the session ID as a secure, HttpOnly cookie in the response. The frontend receives the response and the browser automatically stores the session cookie.

For subsequent requests, the browser will automatically include the session cookie and the backend authMiddleware will extract and validate the session ID from the cookie.

This approach would simplify the frontend codebase and reduce the amount of state management needed in the frontend.

### Future Improvements:

### Other Considerations:
